# 技術ドキュメント一括Markdown化ツール 開発プラン

## プロジェクト概要
Web上の技術ドキュメントサイトのコンテンツを、サイトの階層構造を維持したまま一括でMarkdownファイルに変換・保存するコマンドラインツールの開発。

## 開発フェーズ

### フェーズ1: プロジェクトセットアップと依存関係
1. **プロジェクト構造の作成**
   - `main.py` - メインエントリーポイントと全体調整
   - `crawler.py` - Webクローリングとリンク発見
   - `converter.py` - HTMLからMarkdownへの変換
   - `config.yaml` - 設定テンプレート
   - `requirements.txt` - Python依存関係
   - `README.md` - 使用方法説明

2. **requirements.txtでの依存関係セットアップ**
   - `requests` - HTTPリクエスト
   - `beautifulsoup4` - HTML解析
   - `lxml` - 高速XML/HTMLパーサー
   - `pyyaml` - YAML設定解析
   - `html2text` - HTMLからMarkdownへの変換

### フェーズ2: 設定管理
3. **設定ハンドラーの作成**
   - `config.yaml`の読み込みと検証
   - デフォルト値の提供
   - 設定エラーの適切な処理

4. **サンプル設定の作成**
   - 仕様に基づいたPythonドキュメントを例とした設定

### フェーズ3: Webクローラー実装
5. **クローラークラスの実装**
   - URLキューの管理
   - 重複URL検出
   - ドメインとパターンフィルタリング
   - ナビゲーションセレクターベースのリンク発見
   - リクエスト制限
   - HTTP失敗のエラーハンドリング

### フェーズ4: コンテンツ変換
6. **HTMLからMarkdown変換器の実装**
   - CSSセレクターを使用したコンテンツ抽出
   - 適切なフォーマットでのHTMLからMarkdown変換
   - コードブロック言語の保持
   - 画像処理（ダウンロード vs URL保持）
   - ローカルファイル用のリンクURL調整

### フェーズ5: ファイルシステム操作
7. **ファイル管理の実装**
   - URLパスに基づいたディレクトリ構造の作成
   - 特殊ケースの処理（`index.html` → `README.md`）
   - 適切なエンコーディングでのMarkdownファイル保存
   - 画像のダウンロードと整理

### フェーズ6: メインアプリケーションロジック
8. **メイン調整機能の作成**
   - 全コンポーネントの初期化
   - クローリングプロセスの管理
   - 進捗レポートの提供
   - 適切なシャットダウン

### フェーズ7: エラーハンドリングとロギング
9. **包括的エラーハンドリングの追加**
   - ネットワーク失敗
   - コンテンツ抽出失敗
   - ファイルシステムエラー
   - 設定エラー

10. **進捗ログの実装**
    - フォーマット: `[現在/総数] 処理中: (URL)`

### フェーズ8: テストとドキュメント
11. **一般的なドキュメントサイト用の設定例作成**
12. **使用方法説明と例の追加**

## 技術仕様
- **言語**: Python 3.9以上
- **主要ライブラリ**: requests, beautifulsoup4, lxml, pyyaml, html2text
- **設定駆動**: `config.yaml`による完全な動作制御
- **エラー耐性**: 個別ページの失敗でも処理続行

## 実行方法
```bash
pip install -r requirements.txt
python main.py
```

このプランにより、様々なドキュメントサイトに対応できる堅牢で設定駆動のツールを作成し、構造を保持しながら読みやすいMarkdown形式に変換します。

## 開発進捗状況

### フェーズ7: エラーハンドリングとロギング強化 (部分完了)

#### 7.1 進捗ログ書式の改善 ✅ COMPLETED
- **実装完了日**: 2025-01-06
- **実装内容**: 
  - 仕様通りの「[現在/総数] 処理中: (URL)」形式に修正
  - 動的総数計算ロジックの実装（処理済み + キューの残り）
  - main.py:85行目とcrawler.py:288行目の一貫した書式統一
- **技術詳細**:
  - `total_count = processed_count + self.crawler.url_queue.size()` による動的総数計算
  - URLを括弧で囲む形式: `(URL)` に変更
  - main.pyとcrawler.pyで統一された進捗表示ロジック

#### 7.2 エラー分類システム ✅ COMPLETED
- **実装完了日**: 2025-01-06
- **実装内容**:
  - 4種類のエラー分類Enum（NetworkError, ContentExtractionError, FileSystemError, ConfigError）
  - 各モジュールでの詳細なエラー分類と処理統合
  - エラー重要度システム（LOW, MEDIUM, HIGH, CRITICAL）の実装
- **技術詳細**:
  - `error_types.py`: 統合エラーハンドリングシステムの基盤
  - `crawler.py`: ネットワークエラーの指数バックオフリトライ実装
  - `converter.py`: コンテンツ抽出・ファイル保存エラーの詳細分類
  - `config_manager.py`: 設定検証エラーの構造化処理
  - `main.py`: ファイルシステムエラーとエラー統計表示機能
- **対応戦略**:
  - ネットワークエラー → 3回までの指数バックオフリトライ
  - コンテンツエラー → ログ出力してスキップ、処理継続
  - ファイルシステムエラー → 権限・容量エラーの詳細分類と早期終了
  - 設定エラー → CRITICAL扱いで即座にプログラム終了

#### 7.3 包括的ログシステム ✅ COMPLETED
- **実装完了日**: 2025-01-06
- **実装内容**:
  - 5段階構造化ログレベル（DEBUG, INFO, WARNING, ERROR, CRITICAL）
  - コンソールとファイルで異なるログレベル設定
  - RotatingFileHandlerによる自動ログローテーション機能
  - 実行可能な改善提案付きサマリーレポートシステム
- **技術詳細**:
  - `logging_manager.py`: 包括的ログシステムの統合管理
  - `improvement_advisor.py`: 4分野（ネットワーク、コンテンツ、パフォーマンス、設定）の自動分析
  - `config.yaml`と全サンプル設定にログ設定を追加
  - 5MBでの自動ローテーション、設定可能なバックアップ数
- **機能**:
  - 設定ベースのログレベル制御（コンソール・ファイル個別設定）
  - logs/doc_to_md.logへの構造化ログ出力
  - エラー率分析による具体的改善提案
  - 優先度付き実行可能な提案（HIGH/MEDIUM/LOW）
  - request_delay調整、設定最適化、パフォーマンス改善の提案

#### 7.4 復旧メカニズム ✅ COMPLETED
- **実装完了日**: 2025-01-06
- **実装内容**:
  - 設定可能な指数バックオフ自動リトライシステム
  - 問題ページの自動スキップ機能（連続失敗時）
  - 中断・再開機能付き部分結果保存システム
- **技術詳細**:
  - `recovery_manager.py`: JSON形式での状態保存・復元機能
  - `config_manager.py`: retry、recovery設定セクションの追加
  - `crawler.py`: 設定可能なリトライパラメータ（max_retries, backoff_factor, etc.）
  - `main.py`: 中断時自動保存、再開時状態復元の統合
- **新機能**:
  - 最大リトライ回数、バックオフ係数、遅延時間の設定可能化
  - HTTPステータスコード別リトライ判定（configurable retry_status_codes）
  - 連続失敗回数による自動スキップ（skip_after_failures設定）
  - KeyboardInterrupt時の進行状況自動保存
  - 設定変更検出による互換性チェック機能

### フェーズ8: テストとドキュメント ✅ COMPLETED

#### 8.1 設定例の作成 ✅ COMPLETED
- **実装完了日**: 2025-01-06
- **実装内容**:
  - `config_samples/`ディレクトリの整備
  - 6種類の包括的な設定例を提供
  - Phase 7.4新機能を含む完全な設定テンプレート
- **提供設定例**:
  - `python_docs.yaml`: Python公式ドキュメント用
  - `sphinx_docs.yaml`: Sphinx/readthedocs.org用
  - `github_pages.yaml`: GitHub Pages/Jekyll用
  - `gitbook.yaml`: GitBook用
  - `docs_general.yaml`: 汎用ドキュメントサイト用
  - `minimal.yaml`: 最小設定例
- **技術詳細**:
  - 各設定例に retry, recovery セクションを完全統合
  - ドキュメントサイト別の最適化されたパラメータ
  - 詳細なコメント付き設定説明

#### 8.2 ドキュメント整備 ✅ COMPLETED
- **実装完了日**: 2025-01-06
- **実装内容**:
  - README.md の全面的な更新と強化
  - Phase 7.3/7.4 新機能の詳細説明
  - 包括的なトラブルシューティングガイド
- **追加ドキュメント**:
  - クイックスタートガイド（設定例使用）
  - 全設定項目の詳細説明
  - 中断・再開機能の使用方法
  - エラー処理と統計表示の詳細
  - ログ分析とデバッグ方法
  - よくある問題の解決方法

## 🎉 プロジェクト完了状況

### ✅ 完了済みフェーズ（全8フェーズ）

1. **フェーズ1**: プロジェクトセットアップと依存関係 ✅
2. **フェーズ2**: 設定管理 ✅
3. **フェーズ3**: Webクローラー実装 ✅
4. **フェーズ4**: コンテンツ変換 ✅
5. **フェーズ5**: ファイルシステム操作 ✅
6. **フェーズ6**: メインアプリケーションロジック ✅
7. **フェーズ7**: エラーハンドリングとロギング強化 ✅
   - 7.1 進捗ログ書式の改善 ✅
   - 7.2 エラー分類システム ✅
   - 7.3 包括的ログシステム ✅
   - 7.4 復旧メカニズム ✅
8. **フェーズ8**: テストとドキュメント ✅
   - 8.1 設定例の作成 ✅
   - 8.2 ドキュメント整備 ✅

### 🔧 最終機能一覧

**基盤機能**:
- 設定駆動型Webクローリングシステム
- HTML→Markdown変換エンジン
- ディレクトリ構造保持機能

**エラー処理・復旧**:
- 4分類エラーハンドリング（Network/Content/FileSystem/Config）
- 設定可能な指数バックオフリトライシステム
- 問題ページ自動スキップ機能
- 中断・再開対応の部分結果保存システム

**監視・分析**:
- ファイルローテーション付き包括的ログシステム
- 実行結果分析による改善提案システム
- エラー統計とパフォーマンス分析

**ユーザビリティ**:
- 6種類の包括的設定例
- 詳細なドキュメントとトラブルシューティング
- 柔軟な設定バリデーションと検証

このプロジェクトは、様々なドキュメントサイトに対応できる堅牢で設定駆動のMarkdown変換ツールとして完成しました。